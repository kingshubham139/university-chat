<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>University Chat</title>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#e5ddd5}
.chat{
  max-width:520px;height:100vh;margin:auto;
  display:flex;flex-direction:column;background:#fff;
}
header{
  background:#075e54;color:#fff;padding:12px;
  display:flex;justify-content:space-between;align-items:center;
}
header small{font-size:12px}
#messages{
  flex:1;padding:10px;overflow-y:auto;background:#efeae2;
}
.msg{
  max-width:75%;padding:8px 12px;margin:6px 0;
  border-radius:10px;font-size:14px;
}
.me{background:#dcf8c6;margin-left:auto}
.other{background:#fff}
.time{font-size:10px;color:#555;margin-top:2px}
footer{
  display:flex;padding:8px;background:#f0f0f0;
}
footer input{
  flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;
}
footer button{
  margin-left:8px;background:#075e54;color:#fff;
  border:none;padding:10px 16px;border-radius:50%;
}
#typing{font-size:12px;color:#555;padding:4px 10px}
</style>
</head>

<body>
<div class="chat">
<header>
  <div>
    <b id="group"></b><br>
    <small><span id="online">0</span> online</small>
  </div>
  <button onclick="logout()">Logout</button>
</header>

<div id="messages"></div>
<div id="typing"></div>

<footer>
  <input id="input" placeholder="Type message">
  <button onclick="send()">âž¤</button>
</footer>
</div>

<script>
const API = "https://university-chat-production.up.railway.app";
const user = JSON.parse(localStorage.getItem("user"));
if(!user) location.href="index.html";

group.innerText = "Group: " + user.groupName;

const socket = io(API);
socket.emit("join", user.groupName);

socket.on("online", n => online.innerText = n);

socket.on("receive", msg => add(msg));
socket.on("deleted", id => {
  const el = document.getElementById(id);
  if(el) el.remove();
});

let typingTimer;
input.addEventListener("input", ()=>{
  socket.emit("typing",{ groupName:user.groupName, username:user.username });
  clearTimeout(typingTimer);
  typingTimer = setTimeout(()=>typing.innerText="",1000);
});

socket.on("typing", name=>{
  typing.innerText = name + " is typing...";
  setTimeout(()=>typing.innerText="",1000);
});

function send(){
  const text = input.value.trim();
  if(!text) return;

  socket.emit("send",{
    text,
    sender:user.username,
    groupName:user.groupName
  });
  input.value="";
}

input.addEventListener("keydown",e=>{
  if(e.key==="Enter") send();
});

function add(m){
  const div = document.createElement("div");
  div.className = "msg " + (m.sender===user.username?"me":"other");
  div.id = m._id;

  const time = new Date(m.createdAt).toLocaleTimeString([],{
    hour:"2-digit",minute:"2-digit"
  });

  div.innerHTML = `
    <b>${m.sender}</b><br>
    ${m.text}
    <div class="time">${time}</div>
  `;

  if(m.sender===user.username){
    div.onclick = ()=>socket.emit("delete",{
      id:m._id,
      username:user.username,
      groupName:user.groupName
    });
  }

  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function logout(){
  localStorage.removeItem("user");
  location.href="index.html";
}
</script>
</body>
</html>

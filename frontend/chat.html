<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>University Chat</title>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#e5ddd5;
}
.chat-app{
  max-width:520px;
  height:100vh;
  margin:auto;
  background:#fff;
  display:flex;
  flex-direction:column;
}

/* HEADER */
header{
  background:#075e54;
  color:#fff;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header .info{
  font-size:14px;
}
header button{
  background:#ff4d4f;
  border:none;
  color:#fff;
  padding:6px 10px;
  border-radius:5px;
  cursor:pointer;
}

/* MESSAGES */
#messages{
  flex:1;
  padding:10px;
  overflow-y:auto;
  background:#efeae2;
}
.msg{
  max-width:75%;
  padding:8px 12px;
  margin:6px 0;
  border-radius:10px;
  font-size:14px;
  line-height:1.4;
  word-wrap:break-word;
}
.me{
  background:#dcf8c6;
  margin-left:auto;
}
.other{
  background:#fff;
}
.sender{
  font-size:11px;
  color:#555;
  margin-bottom:3px;
}

/* TYPING */
#typing{
  font-size:12px;
  color:#555;
  padding:4px 10px;
}

/* FOOTER */
footer{
  display:flex;
  padding:8px;
  background:#f0f0f0;
}
footer input{
  flex:1;
  padding:10px;
  border-radius:20px;
  border:1px solid #ccc;
  outline:none;
}
footer button{
  margin-left:8px;
  background:#075e54;
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:50%;
  cursor:pointer;
}

/* MOBILE FIX */
@media(max-width:600px){
  .chat-app{max-width:100%}
}
</style>
</head>

<body>

<div class="chat-app">
  <header>
    <div class="info">
      <b id="groupName"></b><br>
      <small id="status">Online</small>
    </div>
    <button onclick="logout()">Logout</button>
  </header>

  <div id="messages"></div>
  <div id="typing"></div>

  <footer>
    <input id="msgInput" placeholder="Type a message">
    <button onclick="send()">âž¤</button>
  </footer>
</div>

<script>
const API = "https://university-chat-production.up.railway.app";

// SESSION CHECK
const user = JSON.parse(localStorage.getItem("user"));
if(!user){
  location.href="index.html";
}

groupName.innerText = "Group: " + user.groupName;

// SOCKET
const socket = io(API);
socket.emit("join", user.groupName);

// RECEIVE MESSAGE
socket.on("receive", data => {
  addMessage(data);
});

// DELETE MESSAGE
socket.on("deleted", id => {
  const el = document.getElementById(id);
  if(el) el.remove();
});

// TYPING INDICATOR (basic)
let typingTimeout;
msgInput.addEventListener("input",()=>{
  socket.emit("typing", user.username);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>{
    typing.innerText="";
  },1000);
});

socket.on("typing", name=>{
  typing.innerText = name + " is typing...";
  setTimeout(()=>typing.innerText="",1000);
});

// SEND MESSAGE
function send(){
  const text = msgInput.value.trim();
  if(text==="") return;

  socket.emit("send",{
    text,
    sender:user.username,
    groupName:user.groupName
  });
  msgInput.value="";
}

// ENTER KEY SEND
msgInput.addEventListener("keydown",e=>{
  if(e.key==="Enter") send();
});

// ADD MESSAGE TO UI
function addMessage(m){
  const div = document.createElement("div");
  div.className = "msg " + (m.sender===user.username?"me":"other");
  div.id = m._id;

  div.innerHTML = `
    <div class="sender">${m.sender}</div>
    <div>${m.text}</div>
  `;

  if(m.sender===user.username){
    div.onclick = ()=>socket.emit("delete", m._id);
  }

  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

// LOGOUT
function logout(){
  localStorage.removeItem("user");
  location.href="index.html";
}
</script>

</body>
</html>
